

| Property           | Value                                                            |
| ------------------ | ---------------------------------------------------------------- |
| SHA256             | 178BA564B39BD07577E974A9B677DFD86FFA1F1D0299DFD958EB883C5EF6C3E1 |
| Description        | nProtect KeyCrypt Program Database DLL                           |
| CPU                | 32-bit                                                           |
| Compiler Timestamp | Fri Apr 24 02:04:11 2020 \| UTC                                  |



## Observations

#### Static
1. Entropy is **7.536** which is high for an executable
2. Has a new section called **.text1**
	1. ![](attachments/Pasted%20image%2020240428093358.png)
	2. Entropy of this section is **7.958** which could indicate that the section contains an encrypted payload
3. Has a resource with an `EXCEL` header
	1. ![](attachments/Pasted%20image%2020240428093544.png)

#### Dynamic
1. Debugging using x32dbg
2. Added breakpoints at VirtualProtect, VirtualAlloc and CreateProcessInternalW
3. First breakpoint gets triggered at VirtualAlloc which allocates **0x2B000** or **176,128** bytes of memory
4. VirtualAlloc returns **0x880000** which is the start address of the newly allocated memory
5. Memory dump for this address reveals an empty memory location with all bytes zeroed out
	1. ![](attachments/Pasted%20image%2020240428095916.png)
6. VirtualAlloc is executed again and this time requesting for **0x6000** or **24,576** bytes of memory
7. VirtualAlloc returns **0x520000** with all bytes zeroed out
8. The previously allocated memory at **0x880000** interestingly seems to have been loaded with some content which might be another PE
	1. It has the usual DOS stub message found in all Portable Executable files but it doesn't seem to have the Magic Header for a PE (MZ)
	2. ![](attachments/Pasted%20image%2020240428101231.png)
	3. Further down, it seems to have sections loaded into memory
	4. ![](attachments/Pasted%20image%2020240428101317.png)
9. Continuing the analysis, VirtualAlloc is triggered the 3rd time with a request to allocate **0x2A000** or **172,032** bytes of memory
10. VirtualAlloc allocates memory at **0x2300000** which is all zeroed out as usual
11. Again, the memory that was allocated before at **0x520000** seems to be loaded with what looks like a proper PE executable. It has the MZ header string, DOS stub message and the secions
	1. ![](attachments/Pasted%20image%2020240428101955.png)
	2. ![](attachments/Pasted%20image%2020240428102013.png)
12. Then, the breakpoint on VirtualProtect gets triggered
	1. lpAddress = **0x10000000**
	2. dwSize = **0x35000** - targets **0x10000000** to **0x10035000**
	3. flNewProtect = **0x04** = PAGE_READWRITE
13. **0x10000000** targets the current executable. Before VirtualProtect, the state of the memory map was
	1. ![](attachments/Pasted%20image%2020240428105320.png)
14. After VirtualProtect, memory map changes to
	1. ![](attachments/Pasted%20image%2020240428105418.png)
15. VirtualProtect is called again
	1. lpAddress = **0x10000000**
	2. dwSize = **0x400** - targets **0x10000000** to **0x10000400**
	3. flNewProtect = **0x02** = PAGE_READONLY
	4. ![](attachments/Pasted%20image%2020240428110226.png)
16. And again
	1. lpAddress = **0x10001000**
	2. dwSize = **0x20D11** - targets **0x10001000** to **0x10021D11**
	3. flNewProtect = **0x20** = PAGE_EXECUTE_READ
	4. This probably targets the `.text` section of the executable
	5. ![](attachments/Pasted%20image%2020240428110858.png)
17. Aaand again,
	1. lpAddress = **0x10022000**
	2. dwSize = **0x5EFE** - targets **0x10022000** to **0x10027EFE**
	3. flNewProtect = **0x2** = PAGE_READONLY
	4. Targets part of the `.text1` section
18. Yet again
	1. lpAddress = **0x10028000**
	2. dwSize = **0x3E8** - targets **0x10028000** to **0x100283E8**
	3. flNewProtect = **0x04** = PAGE_READWRITE
	4. Still targets part of the `.text1` section
19. Still going on
	1. lpAddress = **0x10029000**
	2. dwSize = **0xEC8** - targets **0x10029000** to **0x10029EC8**
	3. flNewProtect = **0x02** = PAGE_READONLY
	4. Still targets part of the `.text1` section
20. And, a reminder on how much time I've spent on this :smile:
	1. ![](attachments/Pasted%20image%2020240428112117.png)
21. Finally, no more VirtualAlloc calls. Although, the debugger hit an exception breakpoint which we need to find out why.
22. At this point, we can dump the newly created memory to file and start analyzing that after a quick memory mapping exercise
23. 